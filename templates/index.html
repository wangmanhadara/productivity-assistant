<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cloud Productivity Assistant</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7fb;color:#111827;margin:0;}
    .container{max-width:1100px;margin:40px auto;padding:0 16px;}
    h1{font-size:22px;margin:0 0 6px 0;}
    .sub{margin:0;color:#6b7280;font-size:14px;line-height:1.4;max-width:820px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start;margin-top:14px;}
    @media (max-width:980px){.grid{grid-template-columns:1fr;}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;box-shadow:0 8px 24px rgba(17,24,39,0.06);}
    .title{font-size:13px;font-weight:800;color:#374151;margin:0 0 10px 0;}
    textarea{width:100%;min-height:260px;padding:12px;border-radius:10px;border:1px solid #d1d5db;font-size:14px;line-height:1.45;resize:vertical;outline:none;}
    textarea:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,0.15);}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    button{padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;background:#fff;cursor:pointer;font-weight:800;font-size:13px;}
    button.primary{background:#2563eb;color:#fff;border-color:#2563eb;}
    button.warn{background:#f59e0b;color:#111827;border-color:#f59e0b;}
    button:hover{filter:brightness(0.98);}
    .hint{margin-top:10px;color:#6b7280;font-size:12px;line-height:1.45;}
    pre{margin:0;padding:12px;border-radius:10px;border:1px solid #e5e7eb;background:#0b1220;color:#e5e7eb;overflow-x:auto;white-space:pre-wrap;word-break:break-word;line-height:1.45;font-size:13px;min-height:260px;}
    .row{margin-top:14px;}

    .day{border:1px solid #e5e7eb;border-radius:12px;background:#fff;box-shadow:0 6px 18px rgba(17,24,39,0.05);overflow:hidden;}
    .day-hd{padding:12px 14px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;gap:12px;align-items:center;}
    .day-hd b{font-size:14px;}
    .date{color:#6b7280;font-size:12px;}
    .blocks{padding:12px 14px;display:grid;gap:10px;}

    .block{border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;background:#f8fafc;}
    .block .t{font-weight:800;}
    .block .m{color:#6b7280;font-size:12px;margin-top:3px;line-height:1.35;}

    .empty{color:#6b7280;font-size:13px;line-height:1.4;padding:12px 14px;}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Cloud Productivity Assistant</h1>
    <p class="sub">Left: paste text → Extract. Right: readable extracted tasks → Add to weekly plan. Bottom: weekly plan shown by date.</p>

    <div class="grid">
      <!-- Left: input -->
      <div class="card">
        <p class="title">Input Text</p>
        <form method="post" action="/ui/action">
          <textarea name="text" placeholder="Paste email / notes / prompt here...">{{ input_text or "" }}</textarea>
          <input type="hidden" name="action" value="extract_preview" />
          <div class="actions">
            <button class="primary" type="submit">Extract</button>
            <button type="button" onclick="location.href='/'">Clear</button>
            <button type="button" onclick="submitViewWeek()">View Weekly Plan</button>
          </div>
          <div class="hint">Extract does not modify your plan. Add button on the right saves tasks to Firestore.</div>
        </form>
      </div>

      <!-- Right: extracted -->
      <div class="card">
        <p class="title">Extracted Tasks</p>

        {% if extracted_tasks and extracted_tasks|length > 0 %}
          <div style="display:grid;gap:10px;">
            {% for t in extracted_tasks %}
              <div class="block">
                <div class="t">{{ t.title or t.task or "Untitled task" }}</div>
                <div class="m">
                  {% if t.due %}<b>Due:</b> {{ t.due }} · {% endif %}
                  {% if t.estimated_minutes %}<b>Est:</b> {{ t.estimated_minutes }} min · {% endif %}
                  {% if t.priority %}<b>Priority:</b> {{ t.priority }} · {% endif %}
                  {% if t.category %}<b>Category:</b> {{ t.category }}{% endif %}
                </div>
                {% if t.notes %}
                  <div class="m" style="margin-top:6px;">{{ t.notes }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>

          <form method="post" action="/ui/action" style="margin-top:12px;">
            <input type="hidden" name="action" value="confirm_add" />
            <input type="hidden" name="pending_tasks_json" value="{{ pending_tasks_json | e }}" />
            <div class="actions">
              <button class="warn" type="submit">Add to Weekly Plan</button>
              <button type="button" onclick="location.href='/'">Discard</button>
            </div>
            <div class="hint">This updates Firestore + increments plan version.</div>
          </form>

          <details style="margin-top:12px;">
            <summary style="cursor:pointer;color:#6b7280;font-weight:800;font-size:13px;">Show raw JSON</summary>
            <div style="margin-top:10px;">
              <pre style="min-height:auto;">{{ extracted_pretty }}</pre>
            </div>
          </details>

        {% else %}
          <pre>{
  "message": "No extracted tasks yet. Paste text and click Extract."
}</pre>
        {% endif %}
      </div>
    </div>

    <!-- Weekly plan by date -->
    <div class="row">
      <div class="card">
        <p class="title">Weekly Plan (by date)</p>
        <div class="hint">Week: <code>{{ week_id or "N/A" }}</code> · Version: <code>{{ week_version or 0 }}</code></div>

        {% if weekly_by_date and weekly_by_date|length > 0 %}
          <div style="display:grid;gap:12px;margin-top:12px;">
            {% for d in weekly_by_date %}
              <div class="day">
                <div class="day-hd">
                  <b>{{ d.day }}</b>
                  <span class="date">{{ d.date }}</span>
                </div>

                {% if d.blocks and d.blocks|length > 0 %}
                  <div class="blocks">
                    {% for b in d.blocks %}
                      <div class="block">
                        <div class="t">{{ b.start }}–{{ b.end }} · {{ b.task }}</div>
                        {% if b.notes %}
                          <div class="m">{{ b.notes }}</div>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="empty">No blocks planned.</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty" style="margin-top:10px;">
            No weekly plan yet. Extract tasks and click <b>Add to Weekly Plan</b>.
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    function submitViewWeek(){
      const f=document.createElement('form');
      f.method='post'; f.action='/ui/action';
      const a=document.createElement('input');
      a.type='hidden'; a.name='action'; a.value='view_week';
      f.appendChild(a);
      document.body.appendChild(f);
      f.submit();
    }
  </script>
</body>
</html>
